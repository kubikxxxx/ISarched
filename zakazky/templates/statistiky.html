{% load static formaty %}
<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="utf-8">
  <title>Statistiky</title>
  <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}">
  <style>
    .card-kpi { min-height: 110px; }
  </style>
</head>
<body class="p-3">
<div class="container-fluid">

  <div class="d-flex justify-content-between align-items-center mb-2">
    <h3 class="mb-0">Statistiky</h3>

    <div class="d-flex align-items-center gap-2">
      <a class="btn btn-sm {% if scope == 'month' %}btn-primary{% else %}btn-outline-secondary{% endif %}"
         href="?scope=month{% if ym %}&ym={{ ym }}{% endif %}">Měsíc</a>
      <a class="btn btn-sm {% if scope == 'year' %}btn-primary{% else %}btn-outline-secondary{% endif %}"
         href="?scope=year{% if y %}&y={{ y }}{% endif %}">Rok</a>
      <a class="btn btn-sm {% if scope == 'all' %}btn-primary{% else %}btn-outline-secondary{% endif %}"
         href="?scope=all">Vše</a>

      {% if scope == 'month' %}
        <a class="btn btn-sm btn-outline-secondary" href="?scope=month&ym={{ prev_ym }}">‹</a>
        <span class="px-2 text-muted">{{ first_day|date:"F Y" }}</span>
        <a class="btn btn-sm btn-outline-secondary" href="?scope=month&ym={{ next_ym }}">›</a>
      {% elif scope == 'year' %}
        <a class="btn btn-sm btn-outline-secondary" href="?scope=year&y={{ prev_y }}">‹</a>
        <span class="px-2 text-muted">{{ y }}</span>
        <a class="btn btn-sm btn-outline-secondary" href="?scope=year&y={{ next_y }}">›</a>
      {% else %}
        <span class="px-2 text-muted">Vše</span>
      {% endif %}
    </div>
  </div>

  <div class="text-muted mb-3">
    Období: {{ first_day|date:"j. n. Y" }} – {{ last_day|date:"j. n. Y" }}
    {% if calc_until and calc_until < last_day %}
      <span class="ms-2">(počítáno do {{ calc_until|date:"j. n. Y" }})</span>
    {% endif %}
  </div>

  <!-- KPI karty -->
  <div class="row g-3 mb-3">
    <div class="col-md-6">
      <div class="card card-kpi">
        <div class="card-body">
          <div class="text-muted">Mzdy zaměstnanci (včetně cestovného)</div>
          <div class="display-5 fw-semibold">{{ employees_total|format_cislo }} Kč</div>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card card-kpi">
        <div class="card-body">
          <div class="text-muted">Fakturace externisté (včetně cestovného)</div>
          <div class="display-5 fw-semibold">{{ externists_total|format_cislo }} Kč</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Mzdy zaměstnanci -->
  <h5 class="mt-3">Mzdy zaměstnanci</h5>
  <div class="table-responsive mb-4">
    <table class="table table-sm align-middle">
      <thead>
      <tr>
        <th>Zaměstnanec</th>
        <th class="text-end">Plán (h)</th>
        <th class="text-end">Hodinová sazba (Kč/h)</th>
        <th class="text-end">Mzda (Kč)</th>
        <th class="text-end">Km</th>
        <th class="text-end">Sazba/km (Kč)</th>
        <th class="text-end">Cestovné (Kč)</th>
        <th class="text-end">Celkem (Kč)</th>
        <th class="text-end">Hodinový celkový náklad (Kč/h)</th>
      </tr>
      </thead>
      <tbody>
      {% for r in employees_rows %}
        <tr>
          <td>{{ r.emp.jmeno }} {{ r.emp.prijmeni }}</td>
          <td class="text-end">{{ r.plan_h|floatformat:2 }}</td>
          <td class="text-end">{{ r.sazba_h|format_cislo }}</td>
          <td class="text-end">{{ r.mzda|format_cislo }}</td>
          <td class="text-end">{{ r.km|floatformat:2 }}</td>
          <td class="text-end">{{ r.sazba_km|format_cislo }}</td>
          <td class="text-end">{{ r.cestovne|format_cislo }}</td>
          <td class="text-end fw-semibold">{{ r.celkem|format_cislo }}</td>
          <td class="text-end">{{ r.celk_naklad_hod|format_cislo }}</td>
        </tr>
      {% empty %}
        <tr><td colspan="9" class="text-center text-muted">Žádná data.</td></tr>
      {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Externisté -->
  <h5 class="mt-3">Fakturace externisté</h5>
  <div class="table-responsive mb-4">
    <table class="table table-sm align-middle">
      <thead>
      <tr>
        <th>Externista</th>
        <th class="text-end">Odpracováno (h)</th>
        <th class="text-end">Hodinová sazba (Kč/h)</th>
        <th class="text-end">Částka (Kč)</th>
        <th class="text-end">Km</th>
        <th class="text-end">Sazba/km (Kč)</th>
        <th class="text-end">Cestovné (Kč)</th>
        <th class="text-end">Celkem (Kč)</th>
        <th class="text-end">Hodinový celkový náklad (Kč/h)</th>
      </tr>
      </thead>
      <tbody>
      {% for r in externist_rows %}
        <tr>
          <td>{{ r.emp.jmeno }} {{ r.emp.prijmeni }}</td>
          <td class="text-end">{{ r.hours|floatformat:2 }}</td>
          <td class="text-end">{{ r.rate_h|format_cislo }}</td>
          <td class="text-end">{{ r.castka|format_cislo }}</td>
          <td class="text-end">{{ r.km|floatformat:2 }}</td>
          <td class="text-end">{{ r.rate_km|format_cislo }}</td>
          <td class="text-end">{{ r.cestovne|format_cislo }}</td>
          <td class="text-end fw-semibold">{{ r.celkem|format_cislo }}</td>
          <td class="text-end">{{ r.celk_naklad_hod|format_cislo }}</td>
        </tr>
      {% empty %}
        <tr><td colspan="9" class="text-center text-muted">Žádná data.</td></tr>
      {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Výkony po zakázkách (v období) -->
  <h5 class="mt-4">Výkony po zakázkách (v období)</h5>
  {% if projects_month_tables %}
    {% for t in projects_month_tables %}
      <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
          <div>
            <strong>{{ t.zakazka.zakazka_cislo }}</strong>
            — {{ t.zakazka.nazev }}
            {% if t.zakazka.klient %}<span class="text-muted">· {{ t.zakazka.klient.nazev }}</span>{% endif %}
          </div>
          <div class="text-end small">
            <span class="text-muted">Celkem hodin:</span> <strong>{{ t.total_hours|floatformat:2 }}</strong>
            · <span class="text-muted">Výnosy:</span> <strong>{{ t.total_vynosy|format_cislo }} Kč</strong>
            · <span class="text-muted">Náklady:</span> <strong>{{ t.total_naklady|format_cislo }} Kč</strong>
            · <span class="text-muted">Zisk:</span>
            <strong class="{% if t.total_zisk < 0 %}text-danger{% endif %}">{{ t.total_zisk|format_cislo }} Kč</strong>
          </div>
        </div>
        <div class="table-responsive">
          <table class="table table-sm mb-0 align-middle">
            <thead>
              <tr>
                <th>Osoba</th>
                <th class="text-end">Hodiny (h)</th>
                <th class="text-end">Náklady (Kč)</th>
                <th class="text-end">Výnosy (Kč)</th>
                <th class="text-end">Zisk (Kč)</th>
              </tr>
            </thead>
            <tbody>
              {% for r in t.rows %}
                <tr>
                  <td>{{ r.emp.jmeno }} {{ r.emp.prijmeni }}</td>
                  <td class="text-end">{{ r.hours|floatformat:2 }}</td>
                  <td class="text-end">{{ r.naklady|format_cislo }}</td>
                  <td class="text-end">{{ r.vynosy|format_cislo }}</td>
                  <td class="text-end {% if r.zisk < 0 %}text-danger{% endif %}">{{ r.zisk|format_cislo }}</td>
                </tr>
              {% empty %}
                <tr><td colspan="5" class="text-center text-muted">Žádná data.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    {% endfor %}
  {% else %}
    <div class="text-muted">V období nejsou žádné výkazy k zobrazení.</div>
  {% endif %}

  <!-- Nové a ukončené zakázky -->
  <div class="row g-3">
    <div class="col-md-6">
      <h6>Nové zakázky v období</h6>
      <ul class="list-group">
        {% for z in new_projects %}
          <li class="list-group-item d-flex justify-content-between">
            <span>{{ z.zakazka_cislo }} — {{ z.nazev }}</span>
            <span class="text-muted">{{ z.zakazka_start|date:"j. n. Y" }}</span>
          </li>
        {% empty %}
          <li class="list-group-item text-muted">Žádná data.</li>
        {% endfor %}
      </ul>
    </div>
    <div class="col-md-6">
      <h6>Ukončené zakázky v období</h6>
      <ul class="list-group">
        {% for z in closed_projects %}
          <li class="list-group-item d-flex justify-content-between">
            <span>{{ z.zakazka_cislo }} — {{ z.nazev }}</span>
            <span class="text-muted">{{ z.zakazka_konec_skut|date:"j. n. Y" }}</span>
          </li>
        {% empty %}
          <li class="list-group-item text-muted">Žádná data.</li>
        {% endfor %}
      </ul>
    </div>
  </div>

  <div class="mt-3">
    <a href="{% url 'homepage' %}" class="btn btn-outline-secondary">← Zpět</a>
  </div>

</div>
<script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>
</body>
</html>
