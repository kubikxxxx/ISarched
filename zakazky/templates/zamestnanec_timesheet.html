{% load static %}
<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="utf-8">
  <title>Timesheet – {{ zamestnanec.jmeno }} {{ zamestnanec.prijmeni }}</title>
  <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}">
  <style>
    .table-timesheet th, .table-timesheet td { text-align:center; vertical-align:middle; padding:.35rem .5rem; font-variant-numeric:tabular-nums; border:1px solid #e9ecef; }
    .table-timesheet th.left-col, .table-timesheet td.left-col { text-align:left; white-space:nowrap; max-width:360px; }
    .table-timesheet th.tot-col, .table-timesheet td.tot-col { font-weight:600; background:#f8f9fa; }
    .wknd { background:#eee !important; }
    .hol  { background:#ffefb6 !important; }
    .row-sum  th, .row-sum  td { background:#e9ecef; font-weight:600; }
    .row-plan th, .row-plan td { background:#e6f7ff; }
    .diff-pos-cell { background:lightgreen !important; color:#fff; font-weight:600; }
    .diff-neg-cell { background:lightcoral !important; color:#fff; font-weight:600; }
    .plan-input { width: 4.5rem; text-align: center; padding:.1rem .25rem; }
  </style>
</head>
<body class="p-3">
  <div class="container-fluid">
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
      <div>
        <h4 class="mb-1">Timesheet – {{ zamestnanec.jmeno }} {{ zamestnanec.prijmeni }}</h4>
        <div class="text-muted small">Období: {{ first_day|date:"j. n. Y" }} – {{ last_day|date:"j. n. Y" }}</div>
      </div>

      <div class="d-flex align-items-center gap-2">
        <div class="btn-group" role="group" aria-label="Navigace měsíců">
          <a class="btn btn-sm btn-outline-secondary" href="?ym={{ prev_ym }}" title="Předchozí měsíc">‹</a>
        </div>

        <form method="get" class="d-inline-flex align-items-center gap-2">
          <input type="month" name="ym" value="{{ ym }}" class="form-control form-control-sm">
        </form>

        <div class="btn-group" role="group" aria-label="Navigace měsíců">
          <a class="btn btn-sm btn-outline-secondary" href="?ym={{ next_ym }}" title="Další měsíc">›</a>
        </div>

        {% if user.is_authenticated and user.is_admin %}
          {% if request.GET.edit_plan %}
            <a class="btn btn-sm btn-outline-secondary" href="?ym={{ ym }}">Zrušit úpravy plánu</a>
          {% else %}
            <a class="btn btn-sm btn-warning" href="?ym={{ ym }}&edit_plan=1">✎ Upravit plán</a>
          {% endif %}
          {% if not month_closed %}
            <a class="btn btn-sm btn-success" href="{% url 'uzavrit_mesic' zamestnanec.id year month %}">✓ Uzavřít měsíc</a>
          {% else %}
            <a class="btn btn-sm btn-outline-danger" href="{% url 'otevrit_mesic' zamestnanec.id year month %}">↺ Zrušit uzavření</a>
          {% endif %}
        {% else %}
          {% if month_closed %}<span class="badge bg-secondary">Měsíc uzavřen</span>{% endif %}
        {% endif %}

        <a href="{% url 'homepage' %}" class="btn btn-sm btn-outline-secondary">← Zpět</a>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table table-sm table-timesheet">
        <thead>
          <tr>
            <th class="left-col">Zakázka</th>
            {% for d in days %}
              <th class="{% if d.weekend %}wknd{% endif %}{% if d.holiday %} hol{% endif %}">{{ d.num }}</th>
            {% endfor %}
            <th class="tot-col">Σ řádek</th>
          </tr>
        </thead>

        <tbody>
        {% if rows %}
          {% for r in rows %}
            <tr>
              <td class="left-col">{{ r.zakazka.zakazka_cislo }} – {{ r.zakazka.nazev }}</td>
              {% for c in r.cells %}
                <td class="{% if c.weekend %}wknd{% endif %}{% if c.holiday %} hol{% endif %}">
                  {% if c.value and c.value|floatformat:2 != '0.00' %}{{ c.value|floatformat:2 }}{% else %}-{% endif %}
                </td>
              {% endfor %}
              <td class="tot-col">{{ r.total|floatformat:2 }}</td>
            </tr>
          {% endfor %}
        {% else %}
          <tr><td colspan="{{ days|length|add:2 }}" class="text-center text-muted">Žádné výkazy v tomto měsíci.</td></tr>
        {% endif %}
        </tbody>

        <tfoot>
          <tr class="row-sum">
            <th class="text-end">Součet dne</th>
            {% for d in days %}
              <th class="{% if d.weekend %}wknd{% endif %}{% if d.holiday %} hol{% endif %}">{{ d.sum|floatformat:2 }}</th>
            {% endfor %}
            <th class="tot-col">{{ month_total|floatformat:2 }}</th>
          </tr>

          {% if user.is_authenticated and user.is_admin and request.GET.edit_plan %}
            <form method="post" action="{% url 'ulozit_plan_mesice' zamestnanec.id %}?ym={{ ym }}">
              {% csrf_token %}
              <tr class="row-plan">
                <th class="text-end">Plán (h)</th>
                {% for d in days %}
                  <th class="{% if d.weekend %}wknd{% endif %}{% if d.holiday %} hol{% endif %}">
                    <input type="number" name="plan_{% firstof forloop.counter %}" step="0.5" min="0" max="24"
                           value="{{ d.plan|floatformat:2 }}" class="form-control form-control-sm plan-input">
                  </th>
                {% endfor %}
                <th class="tot-col">
                  <button class="btn btn-sm btn-primary">Uložit</button>
                  <a href="?ym={{ ym }}" class="btn btn-sm btn-outline-secondary">Zrušit</a>
                </th>
              </tr>
            </form>
          {% else %}
            <tr class="row-plan">
              <th class="text-end">Plán (h)</th>
              {% for d in days %}
                <th class="{% if d.weekend %}wknd{% endif %}{% if d.holiday %} hol{% endif %}">{{ d.plan|floatformat:2 }}</th>
              {% endfor %}
              <th class="tot-col">{{ plan_total|floatformat:2 }}</th>
            </tr>
          {% endif %}

          <tr>
            <th class="text-end">Denní rozdíl</th>
            {% for d in days %}
              <th class="{% if d.weekend %}wknd{% elif d.holiday %}hol{% elif d.diff >= 0 %}diff-pos-cell{% else %}diff-neg-cell{% endif %}">{{ d.diff|floatformat:2 }}</th>
            {% endfor %}
            <th class="tot-col {% if diff_total >= 0 %}diff-pos-cell{% else %}diff-neg-cell{% endif %}">{{ diff_total|floatformat:2 }}</th>
          </tr>
        </tfoot>
      </table>
    </div>

    <div class="mt-3">
      <div><strong>Odpracováno celkem:</strong> {{ month_total|floatformat:2 }} h</div>
      <div><strong>Plán na měsíc:</strong> {{ plan_total|floatformat:2 }} h</div>
      <div>
        <strong>Rozdíl:</strong>
        <span class="{% if diff_total >= 0 %}text-success fw-bold{% else %}text-danger fw-bold{% endif %}">{{ diff_total|floatformat:2 }} h</span>
      </div>
      <div class="mt-2"><strong>Nadpracované hodiny – aktuální:</strong> {{ bank_now|floatformat:2 }} h</div>
      <div><strong>Nadpracované hodiny – po započtení tohoto měsíce{% if month_closed %} (uzavřeno){% endif %}:</strong> {{ projected_bank|floatformat:2 }} h</div>
    </div>
  </div>

  <script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>
</body>
</html>
